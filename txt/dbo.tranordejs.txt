ALTER  function [dbo].[tranordejs](@project nvarchar(20),@tranvcceno nvarchar(20),@chk1 int,@chk2 int)
returns @tmp table(
	noa nvarchar(20)
	,noq nvarchar(20)
	,typea nvarchar(20)
	,custno nvarchar(20)
	,cust nvarchar(50)
	,productno nvarchar(20)
	,product nvarchar(50)
	,uweight float
	,addrno nvarchar(20)
	,addr nvarchar(50)
	,addrno2 nvarchar(20)
	,addr2 nvarchar(50)
	,conn nvarchar(50)
	,tel nvarchar(50)
	,mount float
	,memo nvarchar(max)
	,memo2 nvarchar(max)
	,gmount float
	,emount float
	,[weight] float
	,lengthb float
	,width float
	,gweight float
	,eweight float
	,height float
	,[volume] float
	,[gvolume] float
	,[evolume] float
	,theight float
	,tvolume float
	,[address] nvarchar(100)
	,lat nvarchar(20)
	,lng nvarchar(20)
	,date1 nvarchar(20)
	,time1 nvarchar(20)
	,date2 nvarchar(20)
	,time2 nvarchar(20)
	,allowcar nvarchar(max)
	,chktype nvarchar(20)
	,chk1 bit
	,chk2 bit
	,chk3 bit
	,unit nvarchar(20)
	,n int
) as
begin
	if(upper(@project)='DC')
	begin
		insert into @tmp(n,noa,typea,custno,cust,addrno,addr,addrno2,addr2,memo
			,mount,gmount,emount)
		select 1 n,a.noa+'-'+a.noq,a.typea,b.custno,d.nick,a.addrno,a.addr,a.addrno2,a.addr2,a.memo
			,a.mount,isnull(c.mount,0),0
		from view_tranordes a
		left join view_tranorde b on a.accy=b.accy and a.noa=b.noa
		outer apply(select sum(ISNULL(mount,0)) mount
			from view_trans where noa!=@tranvcceno and ordeno=a.noa+'-'+a.noq ) c
		left join cust d on b.custno=d.noa
		where ISNULL(b.enda,0) = 0
		order by a.noa,a.noq
		
		update @tmp set emount = mount - gmount
		delete @tmp where emount<=0
		
	end
	else if(upper(@project)='WH')
	begin
		insert into @tmp(noa,noq,custno,cust,productno,product,lengthb,width,height
			,mount,unit,volume,[weight],n
			,addrno,addr,addrno2,addr2,chk1,chk2,chk3,memo,memo2,gmount,gvolume,gweight,typea)
		select a.noa,a.noq,b.custno,d.nick,a.productno,a.product,a.lengthb,a.width,a.height
			,a.mount,a.unit,a.volume,a.[weight],1
			,a.addrno,a.addr,a.addrno2,a.addr2,a.chk1,a.chk2,a.chk3,a.memo,a.memo2
			,isnull(c.mount,0),isnull(c.volume,0),isnull(c.[weight],0),a.typea
		from view_tranordes a
		left join view_tranorde b on a.accy=b.accy and a.noa=b.noa
		outer apply(select sum(ISNULL(mount,0)) mount
			,sum(ISNULL(volume,0)) volume 
			,sum(ISNULL([weight],0)) [weight] 
			from view_tranvcces where noa!=@tranvcceno and ordeno=a.noa and no2=a.noq ) c
		left join cust d on b.custno=d.noa
		where ISNULL(b.enda,0) = 0
		order by a.noa,a.noq
		
		update @tmp set conn=b.namea
		from @tmp a
		outer apply(select top 1 namea from conn where noa=a.custno and len(isnull(namea,''))>0 order by noq) b
		
		update @tmp set emount = mount - gmount
		delete @tmp where emount<=0
		update @tmp set [eweight]= round(emount * isnull(b.uweight,0),2)
			 ,[evolume]= round(emount *a.lengthb*a.width*a.height*0.0000353,2) 
			 ,uweight = isnull(b.uweight,0)
		from @tmp a
		left join ucc b on a.productno=b.noa
	end
	else
	begin
		--JS
		if(@chk1=1)
		begin
			--地點:  提貨地點
			insert into @tmp(chktype,chk1,chk2,chk3
				,noa,noq,typea,custno,cust,productno,product,addrno,addr,conn,tel
				,mount,unit,lengthb,width,height,theight,tvolume,memo,gmount
				,date1,time1,date2,time2)
			select '提貨',1,0,0
				,a.noa,a.noq,a.typea,b.custno,d.nick,a.productno,a.product,b.addrno,b.addr,a.conn,a.tel
				,isnull(a.mount,0),a.unit,a.lengthb,a.width,a.height,a.theight,a.tvolume,a.memo,isnull(c.mount,0)
				,a.date1,a.time1,a.date2,a.time2
			from view_tranordes a
			left join view_tranorde b on a.accy=b.accy and a.noa=b.noa
			outer apply(select sum(ISNULL(mount,0)) mount from view_tranvcces where noa!=@tranvcceno and chk1=1 and ordeno=a.noa and no2=a.noq ) c
			left join cust d on b.custno=d.noa
			where ISNULL(b.enda,0) = 0
			order by a.noa,a.noq
		end
		if(@chk2=1)
		begin
			insert into @tmp(chktype,chk1,chk2,chk3
				,noa,noq,typea,custno,cust,productno,product,addrno,addr,conn,tel
				,mount,unit,lengthb,width,height,theight,tvolume,memo,gmount
				,date1,time1,date2,time2)
			select '卸貨',0,1,0
				,a.noa,a.noq,a.typea,b.custno,d.nick,a.productno,a.product,a.addrno,a.addr,a.conn,a.tel
				,isnull(a.mount,0),a.unit,a.lengthb,a.width,a.height,a.theight,a.tvolume,a.memo,isnull(c.mount,0)
				,a.date1,a.time1,a.date2,a.time2
			from view_tranordes a
			left join view_tranorde b on a.accy=b.accy and a.noa=b.noa
			outer apply(select sum(ISNULL(mount,0)) mount from view_tranvcces where noa!=@tranvcceno and chk2=1 and ordeno=a.noa and no2=a.noq ) c
			left join cust d on b.custno=d.noa
			where ISNULL(b.enda,0) = 0
			order by a.noa,a.noq
		end
		
		update @tmp set emount = mount - gmount
		delete @tmp where emount<=0
		update @tmp set [weight]= round(emount * isnull(b.uweight,0),2)
			 ,[volume]= case when upper(@project)='JS' then emount*ceiling(a.lengthb*a.width) else round(emount *a.lengthb*a.width*a.height*0.0000353,2) end
			 ,[tvolume]= case when upper(@project)='JS' then emount*ceiling(a.lengthb*a.width) else ceiling(emount *a.lengthb*a.width*a.height*0.0000353) end
			 ,uweight = isnull(b.uweight,0)
		from @tmp a
		left join ucc b on a.productno=b.noa
		update @tmp set [address]=isnull(b.[address],'')
			,lat=isnull(b.lat,'')
			,lng=isnull(b.lng,'')
		from @tmp a
		left join addr2 b on a.addrno=b.noa
	end
	
	return 
end